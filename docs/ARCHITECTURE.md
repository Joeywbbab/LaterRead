# æ¶æ„è®¾è®¡

## ç³»ç»Ÿæ¦‚è§ˆ

LaterRead é‡‡ç”¨**åŒç«¯æ¶æ„**ï¼šmacOS èœå•æ  App + Obsidian æ’ä»¶ï¼Œå…±äº«åŒä¸€ä»½ Markdown æ•°æ®æ–‡ä»¶ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  macOS èœå•æ  App (Swift/SwiftUI)   â”‚
â”‚  â€¢ å…¨å±€å¿«æ·é”®æ•è·æµè§ˆå™¨é¡µé¢          â”‚
â”‚  â€¢ OpenRouter AI è‡ªåŠ¨åˆ†ç±»            â”‚
â”‚  â€¢ æ‰¹é‡å¤„ç† + é™æµæ§åˆ¶               â”‚
â”‚  â€¢ èœå•æ ä¸‹æ‹‰ç•Œé¢                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“ â†‘ è¯»å†™
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å…±äº«æ•°æ®å±‚ (Markdown)              â”‚
â”‚  ~/Library/.../Joeyyyyuwww/         â”‚
â”‚  ã€00ã€‘LaterRead/                    â”‚
â”‚  â”œâ”€â”€ inbox.md     â† å¾…è¯»åˆ—è¡¨        â”‚
â”‚  â”œâ”€â”€ archive.md   â† å·²è¯»å½’æ¡£        â”‚
â”‚  â””â”€â”€ YYYY-WXX.md  â† å‘¨æœ« Digest     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“ â†‘ è¯»å†™
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Obsidian æ’ä»¶ (TypeScript)         â”‚
â”‚  â€¢ ä¾§è¾¹æ è§†å›¾                        â”‚
â”‚  â€¢ æ‰‹åŠ¨æ·»åŠ å’Œç®¡ç†                    â”‚
â”‚  â€¢ å½’æ¡£å’Œ Digest ç”Ÿæˆ                â”‚
â”‚  â€¢ æ–‡ä»¶å˜æ›´ç›‘å¬                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## èœå•æ  App æ¶æ„

### åˆ†å±‚è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LaterReadApp (åº”ç”¨å±‚)       â”‚
â”‚  â€¢ App ç”Ÿå‘½å‘¨æœŸç®¡ç†          â”‚
â”‚  â€¢ AppDelegate               â”‚
â”‚  â€¢ èœå•æ çŠ¶æ€ç®¡ç†            â”‚
â”‚  â€¢ é€šçŸ¥ç³»ç»Ÿ                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ è°ƒç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Views (UI å±‚)               â”‚
â”‚  â€¢ MenuBarView - ä¸»ç•Œé¢      â”‚
â”‚  â€¢ ItemRow - åˆ—è¡¨é¡¹          â”‚
â”‚  â€¢ QuickAddView - å¿«é€Ÿæ·»åŠ    â”‚
â”‚  â€¢ SettingsView - è®¾ç½®ç•Œé¢   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ è°ƒç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Services (æœåŠ¡å±‚)           â”‚
â”‚  â€¢ AIService - AI åˆ†ç±»       â”‚
â”‚  â€¢ InboxManager - æ–‡ä»¶ç®¡ç†   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ è°ƒç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Utils (å·¥å…·å±‚)              â”‚
â”‚  â€¢ KeychainManager - å®‰å…¨å­˜å‚¨â”‚
â”‚  â€¢ BrowserHelper - æµè§ˆå™¨æŠ“å–â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ ä¾èµ–
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Core (æ ¸å¿ƒå±‚)               â”‚
â”‚  â€¢ Models - æ•°æ®æ¨¡å‹         â”‚
â”‚  â€¢ CategoryManager - åˆ†ç±»    â”‚
â”‚  â€¢ Config - é…ç½®ç®¡ç†         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¨¡å—è¯´æ˜

| æ¨¡å— | å¤§å° | èŒè´£ |
|------|------|------|
| **Config.swift** | 1.1KB | Vault è·¯å¾„ã€API é…ç½®ã€URL ç”Ÿæˆ |
| **Models.swift** | 786B | ReadingItem æ•°æ®ç»“æ„ |
| **CategoryManager.swift** | 2.4KB | 10 å¤§åˆ†ç±»å®šä¹‰ã€å…³é”®è¯ã€Prompt |
| **KeychainManager.swift** | 2.0KB | API Key å®‰å…¨å­˜å‚¨ï¼ˆmacOS Keychainï¼‰|
| **AIService.swift** | 4.8KB | OpenRouter API è°ƒç”¨ã€é”™è¯¯å¤„ç† |
| **BrowserHelper.swift** | 2.0KB | AppleScript æŠ“å–æµè§ˆå™¨ä¿¡æ¯ |
| **InboxManager.swift** | 5.1KB | Markdown è§£æ/ç”Ÿæˆã€æ–‡ä»¶ I/O |
| **LaterReadApp.swift** | 5.9KB | App å…¥å£ã€ç”Ÿå‘½å‘¨æœŸã€èœå•æ  |
| **Views.swift** | 19KB | æ‰€æœ‰ SwiftUI è§†å›¾ç»„ä»¶ |

### è®¾è®¡åŸåˆ™

1. **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªæ¨¡å—è´Ÿè´£ä¸€ä¸ªæ˜ç¡®çš„åŠŸèƒ½
2. **ä¾èµ–æ³¨å…¥**ï¼šé€šè¿‡ `shared` å•ä¾‹ç®¡ç†æœåŠ¡
3. **åˆ†å±‚æ¸…æ™°**ï¼šé«˜å±‚ä¾èµ–ä½å±‚ï¼Œä½å±‚ä¸ä¾èµ–é«˜å±‚
4. **æ˜“äºæµ‹è¯•**ï¼šå„æ¨¡å—ç‹¬ç«‹ï¼Œå¯å•ç‹¬æµ‹è¯•
5. **ä¾¿äºç»´æŠ¤**ï¼šå°æ–‡ä»¶ï¼ŒèŒè´£æ¸…æ™°

---

## æ•°æ®æµ

### ä¿å­˜æµç¨‹

```
1. ç”¨æˆ·æŒ‰ âŒ˜â‡§L
   â†“
2. HotKey è§¦å‘ captureCurrentPage()
   â†“
3. BrowserHelper é€šè¿‡ AppleScript è·å–é¡µé¢ä¿¡æ¯
   â†“
4. QuickAddWindow æ˜¾ç¤ºå¿«é€Ÿæ·»åŠ ç•Œé¢
   â†“
5. ç”¨æˆ·ç¡®è®¤ â†’ saveItem()
   â†“
6. InboxManager.appendItem() å†™å…¥ inbox.md
   â†“
7. åå° Task è°ƒç”¨ AIService.classify()
   â†“
8. OpenRouter API è¿”å›åˆ†ç±»å’Œæ‘˜è¦
   â†“
9. InboxManager.updateItem() æ›´æ–° inbox.md
   â†“
10. åˆ·æ–° MenuBarView
```

### AI åˆ†ç±»æµç¨‹

```
1. AIService.classify(title, url, domain, apiKey)
   â†“
2. æ„å»º Promptï¼ˆåŒ…å« CategoryManager çš„åˆ†ç±»å®šä¹‰ï¼‰
   â†“
3. POST https://openrouter.ai/api/v1/chat/completions
   â†“
4. è§£æ JSON å“åº” {"summary": "...", "category": "..."}
   â†“
5. è¿”å› Result<ClassificationResult, APIError>
   â†“
6. è°ƒç”¨æ–¹å¤„ç†æˆåŠŸ/å¤±è´¥
```

### é”™è¯¯å¤„ç†

```swift
enum APIError: LocalizedError {
    case unauthorized       // 401/403 - API Key æ— æ•ˆ
    case rateLimited        // 429 - è¯·æ±‚è¿‡äºé¢‘ç¹
    case serverError(Int)   // 5xx - æœåŠ¡å™¨é”™è¯¯
    case invalidResponse    // å“åº”æ ¼å¼é”™è¯¯
    case networkError(Error) // ç½‘ç»œè¿æ¥å¤±è´¥
}
```

æ¯ç§é”™è¯¯éƒ½æœ‰æ¸…æ™°çš„ä¸­æ–‡æç¤ºï¼Œä¾¿äºç”¨æˆ·ç†è§£ã€‚

---

## Obsidian æ’ä»¶æ¶æ„

### ç»„ä»¶ç»“æ„

```typescript
Plugin (main.ts)
â”œâ”€â”€ Settings (LaterReadSettings)
â”‚   â”œâ”€â”€ claudeApiKey
â”‚   â”œâ”€â”€ inboxPath
â”‚   â”œâ”€â”€ archivePath
â”‚   â””â”€â”€ autoClassify
â”‚
â”œâ”€â”€ View (LaterReadView)
â”‚   â”œâ”€â”€ Header
â”‚   â”œâ”€â”€ ItemList
â”‚   â”‚   â”œâ”€â”€ ItemRow
â”‚   â”‚   â”‚   â”œâ”€â”€ Title
â”‚   â”‚   â”‚   â”œâ”€â”€ Summary
â”‚   â”‚   â”‚   â”œâ”€â”€ Actions (Read/Delete)
â”‚   â”‚   â”‚   â””â”€â”€ Note
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ Footer (Add/Digest/Archive)
â”‚
â””â”€â”€ Services
    â”œâ”€â”€ loadItems()
    â”œâ”€â”€ saveItems()
    â”œâ”€â”€ classifyWithClaude()
    â”œâ”€â”€ generateDigest()
    â””â”€â”€ archiveRead()
```

### å…³é”®åŠŸèƒ½

1. **æ–‡ä»¶ç›‘å¬**ï¼šè‡ªåŠ¨ç›‘å¬ `inbox.md` å˜æ›´å¹¶åˆ·æ–°ç•Œé¢
2. **Claude API**ï¼šè°ƒç”¨ Claude API è¿›è¡Œåˆ†ç±»
3. **Digest ç”Ÿæˆ**ï¼šæŒ‰å‘¨ç”Ÿæˆé˜…è¯»æ¸…å•
4. **å½’æ¡£ç®¡ç†**ï¼šå·²è¯»æ¡ç›®è‡ªåŠ¨å½’æ¡£

---

## æ•°æ®æ ¼å¼

### Markdown ç»“æ„

```markdown
# ğŸ“– LaterRead Inbox

## ğŸ¤– AI/Tech

- [ ] ğŸ¤– [Title](url) | domain | 2025-01-12
>  Summary text
> ğŸ“ Note text

## ğŸ› ï¸ Dev Tools

- [x] ğŸ› ï¸ [Title](url) | domain | 2025-01-11
```

### è§£æè§„åˆ™

æ­£åˆ™è¡¨è¾¾å¼ï¼š
```swift
let pattern = #"^- \[([ x])\] (emoji) \[(.+?)\]\((.+?)\) \| (.+?) \| (.+?)$"#
```

å­—æ®µæ˜ å°„ï¼š
- Group 1: `[ ]` æˆ– `[x]` â†’ `isRead`
- Group 2: Emoji â†’ `category`
- Group 3: Title â†’ `title`
- Group 4: URL â†’ `url`
- Group 5: Domain â†’ `domain`
- Group 6: Date â†’ `createdAt`

æ‘˜è¦å’Œå¤‡æ³¨ï¼š
- ä¸‹ä¸€è¡Œ `>  ` å¼€å¤´ â†’ `summary`
- ä¸‹ä¸€è¡Œ `> ğŸ“ ` å¼€å¤´ â†’ `note`

---

## æŠ€æœ¯æ ˆ

### macOS App

- **è¯­è¨€**ï¼šSwift 5.9+
- **UI æ¡†æ¶**ï¼šSwiftUI
- **ä¾èµ–**ï¼š
  - [HotKey](https://github.com/soffes/HotKey) - å…¨å±€å¿«æ·é”®
  - Keychain Services - å®‰å…¨å­˜å‚¨
  - URLSession - ç½‘ç»œè¯·æ±‚

### Obsidian æ’ä»¶

- **è¯­è¨€**ï¼šTypeScript
- **æ¡†æ¶**ï¼šObsidian Plugin API
- **æ„å»ºå·¥å…·**ï¼šesbuild

---

## API è®¾è®¡

### OpenRouter API

**Endpoint**: `https://openrouter.ai/api/v1/chat/completions`

**Request**:
```json
{
  "model": "google/gemini-2.5-flash-preview-05-20",
  "max_tokens": 200,
  "messages": [
    {
      "role": "user",
      "content": "åˆ†æè¿™ç¯‡æ–‡ç« å¹¶æä¾›ï¼š\n1. ä¸­æ–‡æ‘˜è¦...\n2. åˆ†ç±»..."
    }
  ]
}
```

**Response**:
```json
{
  "choices": [
    {
      "message": {
        "content": "{\"summary\": \"...\", \"category\": \"ai-tech\"}"
      }
    }
  ]
}
```

### é™æµç­–ç•¥

- **å•æ¬¡è¯·æ±‚**ï¼šç«‹å³æ‰§è¡Œ
- **æ‰¹é‡åˆ†ç±»**ï¼šæ¯æ¬¡è¯·æ±‚é—´éš” 0.5 ç§’
- **é‡è¯•æœºåˆ¶**ï¼š429 é”™è¯¯è‡ªåŠ¨ç­‰å¾…

---

## å®‰å…¨è®¾è®¡

### API Key å­˜å‚¨

- **macOS App**ï¼šä½¿ç”¨ç³»ç»Ÿ Keychain
  ```swift
  KeychainManager.shared.saveAPIKey(key)
  ```

- **Obsidian æ’ä»¶**ï¼šå­˜å‚¨åœ¨æ’ä»¶è®¾ç½®ä¸­ï¼ˆObsidian è´Ÿè´£åŠ å¯†ï¼‰

### æƒé™ç®¡ç†

éœ€è¦çš„ macOS æƒé™ï¼š
1. **è¾…åŠ©åŠŸèƒ½**ï¼šå…¨å±€å¿«æ·é”®
2. **è‡ªåŠ¨åŒ–**ï¼šæ§åˆ¶æµè§ˆå™¨ï¼ˆAppleScriptï¼‰
3. **æ–‡ä»¶è®¿é—®**ï¼šè¯»å†™ Obsidian vault

---

## æ€§èƒ½ä¼˜åŒ–

### æ–‡ä»¶ I/O

- ä½¿ç”¨ `atomically: true` ç¡®ä¿å†™å…¥å®‰å…¨
- è¯»å–æ—¶ä½¿ç”¨ lazy parsing
- é¿å…é¢‘ç¹å†™å…¥ï¼ˆæ‰¹é‡æ“ä½œï¼‰

### UI åˆ·æ–°

- ä½¿ç”¨ `@State` å’Œ `@MainActor` ç®¡ç†çŠ¶æ€
- åå°ä»»åŠ¡ä½¿ç”¨ `Task` å¼‚æ­¥æ‰§è¡Œ
- é¿å…é˜»å¡ä¸»çº¿ç¨‹

### API è°ƒç”¨

- æ‰¹é‡åˆ†ç±»è‡ªåŠ¨é™æµ
- ä½¿ç”¨ `URLSession` è¿æ¥æ± 
- 30 ç§’è¶…æ—¶ä¿æŠ¤

---

## æ‰©å±•æ€§

### æ·»åŠ æ–°åˆ†ç±»

1. ç¼–è¾‘ `CategoryManager.swift`:
   ```swift
   "new-cat": ("ğŸ‰", "New Category", "keywords")
   ```

2. æ›´æ–° `categoryOrder`:
   ```swift
   static let categoryOrder = [..., "new-cat"]
   ```

### æ›´æ¢ AI æ¨¡å‹

ç¼–è¾‘ `Config.swift`:
```swift
static let aiModel = "anthropic/claude-3-sonnet"
static let apiEndpoint = "https://..."
```

### æ”¯æŒæ–°æµè§ˆå™¨

æ·»åŠ åˆ° `BrowserHelper.swift`:
```swift
private static let newBrowserScript = """
tell application "NewBrowser"
    ...
end tell
"""
```

---

## æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•

```swift
// æµ‹è¯•åˆ†ç±»é€»è¾‘
func testCategoryDetection() {
    let result = CategoryManager.emoji(for: "ai-tech")
    XCTAssertEqual(result, "ğŸ¤–")
}

// æµ‹è¯• Markdown è§£æ
func testMarkdownParsing() {
    let content = "- [ ] ğŸ¤– [Title](url) | domain | 2025-01-12"
    let items = InboxManager.shared.parseMarkdown(content)
    XCTAssertEqual(items.count, 1)
}
```

### é›†æˆæµ‹è¯•

- æµ‹è¯•å®Œæ•´çš„ä¿å­˜æµç¨‹
- æµ‹è¯• AI åˆ†ç±»ï¼ˆä½¿ç”¨ mock APIï¼‰
- æµ‹è¯•æ–‡ä»¶åŒæ­¥

---

## éƒ¨ç½²

### æ„å»º Release

```bash
cd laterread-mvp/menubar-app
swift build -c release
```

### åˆ›å»º App Bundle

```bash
mkdir -p LaterRead.app/Contents/MacOS
cp .build/release/LaterRead LaterRead.app/Contents/MacOS/
# åˆ›å»º Info.plist
# ä»£ç ç­¾åï¼ˆå¯é€‰ï¼‰
```

### åˆ†å‘

- ç›´æ¥åˆ†å‘ `.app` æ–‡ä»¶
- æˆ–ä½¿ç”¨ DMG æ‰“åŒ…
- æœªæ¥ï¼šApp Store ä¸Šæ¶ï¼ˆéœ€è¦è¯ä¹¦ï¼‰
